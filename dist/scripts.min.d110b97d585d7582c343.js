(()=>{document.addEventListener("alpine:init",()=>{let _nextUploadTime=0,_dropzoneDisabled=!1;function _handleDropzone(e,i){e.addEventListener("dragover",i=>{i.preventDefault(),_dropzoneDisabled||e.classList.add("luh__dropzone-dragging")}),e.addEventListener("dragleave",i=>{e.classList.remove("luh__dropzone-dragging")}),e.addEventListener("drop",t=>{t.preventDefault(),e.classList.remove("luh__dropzone-dragging"),_dropzoneDisabled||i(t)})}function _validateFile(e,i,t){return t.acceptsMimeTypes.length>0&&!t.acceptsMimeTypes.includes(e.type)?(i[e.name]=window.livewireUploadHandlerParams.invalidFileTypeErrorMessage,!1):!(t.maxFileSize>0&&e.size>t.maxFileSize)||(i[e.name]=window.livewireUploadHandlerParams.fileTooLoudErrorMessage,!1)}function _waitBeforeNextUpload(){_nextUploadTime=Math.max(_nextUploadTime,Date.now());const e=_nextUploadTime-Date.now();return _nextUploadTime+=1050,new Promise(i=>setTimeout(i,e))}function _compressImage(file,settings){const compressorjs=eval(window.livewireUploadHandlerParams.compressorjsVar);return compressorjs&&file.type.startsWith("image/")?new Promise((e,i)=>{settings.success=e,settings.error=i,new compressorjs(file,settings)}):file}Alpine.data("LivewireUploadHandlerGroup",$wire=>({groupErrors:{},filesFromGroup:[],nbRunningActions:{group:0,items:0},queuedActions:{group:[],items:[]},sortablejsObj:null,itemsIncrementInProgress:!1,init(){$wire.watch("items",(e,i)=>{null===e&&($wire.items=i)})},initDropzone(){_handleDropzone(this.$el,e=>{this.upload(e.dataTransfer.files)})},initSortable(){const sortablejs=eval(window.livewireUploadHandlerParams.sortablejsVar),that=this;sortablejs&&$wire.sortable&&(this.sortablejsObj=new sortablejs(this.$el,{draggable:".luh__sort-draggable",handle:".luh__sort-handle",animation:150,onStart(e){_dropzoneDisabled=!0},onEnd(e){const i=e.item.previousSibling.previousSibling;null!==i&&"[if ENDBLOCK]><![endif]"===i.nodeValue&&i.before(e.item),_dropzoneDisabled=!1},store:{set(e){that.sortablejsObj.option("disabled",!0),that._waitItemsActions(async()=>{await $wire.sortItems(e.toArray()),that.sortablejsObj.option("disabled",!1)})}}}))},itemHidden:e=>!(null===$wire.items||!$wire.items[e])&&(!(!$wire.autoSave&&null!==$wire.items[e].id)&&$wire.items[e].deleted),visibleItemsNumber(){return Object.keys($wire.items??{}).filter(e=>!this.itemHidden(e)).length},maxFilesNumberReached(){return!($wire.maxFilesNumber<=0)&&this.visibleItemsNumber()>=$wire.maxFilesNumber},async upload(e){if(this.itemsIncrementInProgress)return;this.filesFromGroup=[],this.itemsIncrementInProgress=!0,this.groupErrors={};for(let i of e)i=await _compressImage(i,$wire.compressorjsSettings),_validateFile(i,this.groupErrors,$wire)&&this.filesFromGroup.push(i);const i=this.filesFromGroup.length;let t=i;if($wire.maxFilesNumber>0)for(let e=$wire.maxFilesNumber-this.visibleItemsNumber();e<i;e++)this.groupErrors[this.filesFromGroup[e].name]=window.livewireUploadHandlerParams.maxFilesNumberReachedMessage,t--;this._waitItemsActions(async()=>{this.sortablejsObj?.option("disabled",!0),await $wire.incrementItems(t),this.sortablejsObj?.option("disabled",!1),this.itemsIncrementInProgress=!1})},_waitItemsActions(e){this._coordinateActions("group",e)},async _coordinateActions(e,i){const t="group"===e?"items":"group";if(this.nbRunningActions[t]>0)this.queuedActions[e].unshift(i);else if(this.nbRunningActions[e]++,await i(),this.nbRunningActions[e]--,this.nbRunningActions[e]<=0)for(;this.queuedActions[t].length>0;)this._coordinateActions(t,this.queuedActions[t].pop())}})),Alpine.data("LivewireUploadHandlerItem",e=>({itemErrors:{},uploading:!1,uploadingFileOriginalName:null,chunkIndex:0,uploadedSizeByChunk:[],deleted:!1,deleteTimer:null,deleteTimerInterval:null,init(){e.watch("itemData",(i,t)=>{null===i&&(e.itemData=t)}),null!==e.uploadFromGroupAtIndex&&this.upload(this.filesFromGroup[e.uploadFromGroupAtIndex]),this.deleted=e.itemData.deleted??!1},initDropzone(){_handleDropzone(this.$el,e=>{this.upload(e.dataTransfer.files[0])})},hasSavedFile:()=>null!==e.savedFileDisk&&null!==e.savedFilePath,uploadProgressValue(){return e.uploadingFileSize?Math.round(100*this.uploadedSizeByChunk.reduce((e,i)=>e+i,0)/e.uploadingFileSize):0},async upload(i){this.itemErrors={};try{if(e.attachedToGroup||(i=await _compressImage(i,e.compressorjsSettings)),!_validateFile(i,this.itemErrors,e))return;this.uploading=!0,this.uploadingFileOriginalName=i.name,this.chunkIndex=0,this.uploadedSizeByChunk=[],this.deleted=!1,e.uploadingFileSize=i.size,e.hasErrorOnUpload=!1,this._uploadChunk(i,0)}catch(e){this._errorOnUpload()}},cancelUpload(){this._waitGroupActions(()=>(this.uploading=!1,e.itemData.deleted=!this.hasSavedFile(),e.cancelUpload("chunkFile"),e.deleteUploadingFile()))},deleteUploadedFile(){this._waitGroupActions(()=>(e.itemData.deleted=!this.hasSavedFile(),e.deleteUploadedFile()))},deleteSavedFile(i=3){if(this.deleted=!0,!e.autoSave)return void(e.itemData.deleted=!0);const t=()=>{this._waitGroupActions(()=>(e.itemData.deleted=!0,e.deleteSavedFile()))};i<=0?t():(this.deleteTimer=i,this.deleteTimerInterval=setInterval(()=>{this.deleteTimer>1?this.deleteTimer--:(clearInterval(this.deleteTimerInterval),t())},1e3))},undeleteSavedFile(){clearInterval(this.deleteTimerInterval),this.deleted=!1,e.itemData.deleted=!1},async _uploadChunk(i,t){this.uploading&&this._waitGroupActions(async()=>{const s=Math.min(t+window.livewireUploadHandlerParams.chunkSize,i.size),a=i.slice(t,s,i.type);a.name=i.name,await _waitBeforeNextUpload(),e.upload("chunkFile",a,()=>{e.hasErrorOnUpload?this._errorOnUpload():(this.uploading&=s<i.size,this.uploading?(this.chunkIndex++,this._uploadChunk(i,s)):e.onlyUpload&&(e.itemData.deleted=!0))},()=>{this._errorOnUpload()},e=>{this.uploadedSizeByChunk[this.chunkIndex]=a.size*e.detail.progress/100})})},_errorOnUpload(){e.attachedToGroup&&!this.hasSavedFile()?this.groupErrors[this.uploadingFileOriginalName]=window.livewireUploadHandlerParams.uploadErrorMessage:this.itemErrors[this.uploadingFileOriginalName]=window.livewireUploadHandlerParams.uploadErrorMessage,this.cancelUpload()},_waitGroupActions(i){e.attachedToGroup?this._coordinateActions("items",i):i()}}))})})();